# PKCS #11 Hardware-Backed Ethereum Signer

`Pkcs11Signer` is an Ethereum‐compatible signer that forwards signing requests
to any device that exposes a [PKCS #11] interface—AWS CloudHSM, YubiHSM 2,
SoftHSM, Thales Luna, or a vendor-specific smart card.  The secret key never
leaves the hardware module; all ECDSA secp256k1 signatures are produced inside
the token and returned to the caller in canonical *low-s* form.

Internally the signer

1. Loads the vendor’s PKCS #11 shared library once per process (*lazy-static*),
2. Opens a read-write session on the first slot that contains a token,
3. Logs in as a regular **Crypto User** (`UserType::User`) using the
`CLOUDHSM_PIN` (or the PIN you supply manually),
4. Locates the public- and private-key objects via arbitrary `Attribute`s
(label, ID, class, …), and
5. Caches the public key, derived address, and object handles for
zero-copy, lock-free reads.

Because the module speaks plain PKCS #11 it is agnostic to how the key was
created—imported, generated by the HSM, or wrapped/unwrapped elsewhere—as
long as it is an **EC secp256k1** key with the `CKA_SIGN` attribute set.

## Sync **and** Async

Unlike the `AwsSigner`, `Pkcs11Signer` supports both the `Signer` (async)
*and* `SignerSync` traits.  The underlying HSM calls are blocking, so the
async methods simply run on the current thread; choose whichever style
integrates best with your codebase.

## Configuration

```rust
use alloy_signer_pkcs11::{Pkcs11Signer, Pkcs11SignerConfig};
use alloy_primitives::ChainId;
use cryptoki::object::Attribute;
fn main() -> anyhow::Result<()> {
    let cfg = Pkcs11SignerConfig::from_env_with_defaults(
        Attribute::Label("my-pub".into()),  // public key selector
        0,                                  // take the first match
        Attribute::Label("my-priv".into()), // private key selector
        0,
        std::env::var("CLOUDHSM_PIN")?.into(),
        "/opt/cloudhsm/lib/libcloudhsm_pkcs11.so".into(),
    );

    let signer = Pkcs11Signer::new(cfg, Some(ChainId::from(1u64)))?;
    println!("signing as: {:?}", signer.address());
    # Ok(()) 
}
```